<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="keywords" content="george redinger" />
    <meta name="description" content="george redinger code" />
    <link rel="stylesheet" href="/stylesheets/styles.css" type="text/css"> 
    <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css"> 
    <link  href="//fonts.googleapis.com/css?family=IM+Fell+DW+Pica:regular,italic" rel="stylesheet" type="text/css" >
    <title></title>
  </head>
  <body>

  <script type="text/javascript" src="http://www.google.com/jsapi?key=ABQIAAAAP_8YDI9gsJp2Kb1LN84m6RRhG9pSH20TEz9wwPtMOR-PPl8h0RSc49wL0W0HC4Uxmli1wOFXeVivkQ"></script>

<script language="Javascript" type="text/javascript">
  google.load("search", "1");
function OnLoad() {
  var searchControl = new google.search.SearchControl();
  var webSearch = new google.search.WebSearch();
  webSearch.setSiteRestriction('github.com/georgeredinger');
  searchControl.addSearcher(webSearch);
  searchControl.draw(document.getElementById("search"));
}
google.setOnLoadCallback(OnLoad);
</script>
 
  <div ID="header">
   <h1><a href="/"> George Redinger</a> </h1>

  </div>
<div id="wrap">
    <div id = "sidebar">
   <ul>
 <li><a href="/about">About me</a></li>                                                           
 <li><a href="http://github.com/georgeredinger">GitHub</a></li>
 <li><a href="http://twitter.com/gredinger">Twitter</a></li>
</ul>
<hr/>
 <h3>Search This Site</h3>
 <div id="search"></div>
 <hr/>
 <div id="github-badge">
     <script type="text/javascript" charset="utf-8">
       GITHUB_USERNAME = "georgeredinger";
       GITHUB_LIST_LENGTH = 10;
       GITHUB_HEAD = "div"; // e.g. change to "h2" for wordpress sidebars
       GITHUB_THEME = "white"; // try 'black'
       GITHUB_TITLE = "Georges code"
       GITHUB_SHOW_ALL = "Show all"
     </script>
     <script src="http://drnicjavascript.rubyforge.org/github_badge/dist/github-badge-launcher.js" type="text/javascript"></script>
  </div >

  </div>
  <div id="main">
        <h1></h1>
            <h2>EventMachine for Syncroholics&#174;</h2>

<p>I like to keep track of Dressage scores published by <a href="http://usdf.org">usdf.org</a>.
USDF has records of about 1.5 million individual rides going back almost 20 years. This is an opportunity for Dressage geeks to engage in <a href="http://en.wikipedia.org/wiki/Sabermetrics">Sabermetrics</a> like analysis of horses and riders.</p>

<p>Being a <a href="http://localhost:4000/2010/08/31/WhoIsOnMyNetwork/">syncroholic</a>, my first solution to the problem of getting the data onto local storage for analysis is predictably syncronous:</p>

<div class="highlight"><pre><code class="bash"><span class="c">#!/usr/bin/env bash</span>
<span class="nv">base_url</span><span class="o">=</span><span class="s2">&quot;http://www.usdf.org/calendar/results.asp?CompetitionPass=&quot;</span>
<span class="k">for </span>id in <span class="o">{</span>2..20000<span class="o">}</span> ; <span class="k">do</span>
<span class="k">  </span>wget --quiet -O <span class="s2">&quot;pages/$id&quot;</span>.html  <span class="s2">&quot;$base_url$id&quot;</span>
<span class="k">done</span>
</code></pre>
</div>


<p>While this works, it takes a while. About 11 hours on a well connected host (2 seconds per wget).</p>

<p>USDF.org publishes a page for each horse show identified by a unique id (url), each show page records from 5 to 1000 rides, depending on the size of the horse show.
About half of the ids in the sequence between 2 and 20000 don&rsquo;t contain any ride data at all, the empty pages take just as long to get as the populated ones.</p>

<p>At the September meeting of the <a href="http://spokane.rubyusersgroup.org/">Spokane RUG</a>, <a href="http://twitter.com/#!/chrisreister">Chris Reister</a> gave a presentation on <a href="http://www.rubyeventmachine.com/">EventMachine</a>.</p>

<p>Inspired by Chris' presentation, I did some experiments to see how much faster concurrent http gets would for getting show results pages from usdf.org.</p>

<p>Here&rsquo;s a chart showing the results of 10 trials getting 100 random pages with &ldquo;FiberIterator&rdquo; concurrency varying between 1 and 20:</p>

<p><img src="/images/concurrent_gets.png" alt="concurrent_gets" /></p>

<p>The chart tells me what I need to know: setting concurrency greater than 5 (5 parallel get requests) does not improve performance.</p>

<p>I used  <a href="https://github.com/igrigorik/em-synchrony">Ilya Grigorik&rsquo;s</a> em-synchrony gem so I  don&rsquo;t have to explicity handle EventMachine callbacks.</p>

<div class="highlight"><pre><code class="ruby"><span class="lineno"> 1</span> <span class="nb">require</span> <span class="s2">&quot;em-synchrony&quot;</span>
<span class="lineno"> 2</span> <span class="nb">require</span> <span class="s2">&quot;em-synchrony/em-http&quot;</span>
<span class="lineno"> 3</span> <span class="nb">require</span> <span class="s2">&quot;em-synchrony/fiber_iterator&quot;</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="no">BASE_URL</span><span class="o">=</span><span class="s2">&quot;http://www.usdf.org/calendar/results.asp?CompetitionPass=&quot;</span>
<span class="lineno"> 6</span> <span class="no">SCORES</span><span class="o">=</span><span class="sr">/&lt;div id=&quot;sub-content&quot;&gt;.*&lt;\/div&gt;/m</span>
<span class="lineno"> 7</span> <span class="no">AFTER_SCORES</span><span class="o">=</span><span class="sr">/&lt;div id=&quot;footer&quot;&gt;.*&lt;\/div&gt;/m</span>
<span class="lineno"> 8</span> <span class="no">NO_RESULTS</span><span class="o">=</span><span class="sr">/There are no results at this time/</span>
<span class="lineno"> 9</span> <span class="no">HTTP_SUCCESS</span><span class="o">=</span><span class="mi">200</span>
<span class="lineno">10</span> <span class="no">CONCURENCY</span><span class="o">=</span><span class="mi">5</span>
<span class="lineno">11</span> <span class="n">urls</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">20000</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="nb">id</span><span class="o">|</span><span class="no">BASE_URL</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="k">def</span> <span class="nf">save_page</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span><span class="n">url</span><span class="p">)</span>
<span class="lineno">14</span>  <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">response_header</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="no">HTTP_SUCCESS</span>
<span class="lineno">15</span>      <span class="k">unless</span> <span class="n">resp</span><span class="o">.</span><span class="n">response</span> <span class="o">=~</span> <span class="no">NO_RESULTS</span> 
<span class="lineno">16</span>          <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;pages/</span><span class="si">#{</span><span class="n">url</span><span class="o">[/</span><span class="p">\</span><span class="n">d</span><span class="o">+</span><span class="vg">$/</span><span class="o">]</span><span class="si">}</span><span class="s2">.html&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
<span class="lineno">17</span>              <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="no">SCORES</span><span class="p">)</span><span class="o">.</span>
<span class="lineno">18</span>                              <span class="nb">to_s</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="no">AFTER_SCORES</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="lineno">19</span>          <span class="k">end</span>
<span class="lineno">20</span>      <span class="k">end</span>
<span class="lineno">21</span>  <span class="k">else</span>
<span class="lineno">22</span>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">resp</span><span class="o">.</span><span class="n">response_header</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="lineno">23</span>  <span class="k">end</span>
<span class="lineno">24</span> <span class="k">end</span>
<span class="lineno">25</span> 
<span class="lineno">26</span> <span class="no">EM</span><span class="o">.</span><span class="n">synchrony</span> <span class="k">do</span>
<span class="lineno">27</span>  <span class="no">EM</span><span class="o">::</span><span class="no">Synchrony</span><span class="o">::</span><span class="no">FiberIterator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="no">CONCURENCY</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">url</span><span class="o">|</span>
<span class="lineno">28</span>      <span class="n">resp</span> <span class="o">=</span> <span class="no">EventMachine</span><span class="o">::</span><span class="no">HttpRequest</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
<span class="lineno">29</span>      <span class="n">save_page</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span><span class="n">url</span><span class="p">)</span>
<span class="lineno">30</span>  <span class="k">end</span>
<span class="lineno">31</span>  <span class="no">EventMachine</span><span class="o">.</span><span class="n">stop</span>
<span class="lineno">32</span> <span class="k">end</span>
</code></pre>
</div>


<p>The Ruby save_page() method saves only pages containing data and then only the html div that contains relevent results.</p>

<p>Using 5 concurrent gets, is about 4 times faster than the one page at a time method. That&rsquo;s about 2.75 hours versus 11 hours  to get 20,000 pages.</p>

<p>Now I can get all the pages in the middle of the night while the human users of usdf.org sleep.</p>

<p>Hello, my name is George, and I am a (Recovering, thanks to EventMachine) Syncroholic.</p>

<p><img src="/images/syncroholic.png" alt="syncroholic" /></p>

  <div id="disqus_thread"> </div>
  </div>

    <script type="text/javascript">
      var disqus_identifier= "/EventMachine/2011/09/09/EventMachine-for-syncroholics/" ;
       (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
           dsq.src = 'http://georgescode.disqus.com/embed.js';
           (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/%3Fref_noscript%3Dgeorgescode">comments powered by Disqus.</a></noscript>

        <script type="text/javascript">
          var disqus_shortname = 'georgescode';
          (function () {
              var s = document.createElement('script'); s.async = true;
                s.src = 'http://disqus.com/forums/georgescode/count.js';
                  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
                }());
              </script>

   </div>
  <div id="footer">
    This site powered by Electricity


  </div>
 </body>
</html>
